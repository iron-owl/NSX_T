# Установка NSX-T в среде vSphere

1. Развернуть OVF-шаблон NSX-T Manager в среде vSphere.
1. Войти в графический интерфейс NSX-T Manager.
1. Добавить лицензионный ключ.
1. Зарегистрировать как минимум один vCenter Server (менеджер конечных точек) в NSX-T Manager.
1. Развернуть два дополнительных узла NSX-T Manager для формирования кластера из трех узлов (из интерфейса NSX-T менеджера).
1. Настроить предварительные требования для узлов-транспортов хоста и Edge.
1. Подготовить узлы-транспорты хоста ESXi (с помощью компонентов NSX-T).
1. Развернуть узлы-транспорты NSX-T Edge (в виде виртуальных машин или на физическом сервере без ОС).
1. Создать кластер NSX-T Edge и добавить в него необходимые узлы-транспорты Edge.

## Размеры NSX-T Manager
* Extra small (очень маленький) развертывает только роль NSX Cloud Service Manager (CSM) и не развертывает полный NSX-T Manager со всеми необходимыми ролями.
* Small (маленький) должен развертываться только в средах для Proof of Concept (PoC).
* Medium (средний) может использоваться в производственной среде с количеством до 64 узлов-транспортов хоста ESXi.
* Large (большой) может использоваться в большой производственной среде с более чем 64 узлами-транспортами хоста ESXi. Текущая версия NSX-T 3.x.x поддерживает до 1024 узлов-транспортов хоста ESXi.

Если у вас уже работает кластер с форм-фактором small (маленький) и вам нужно перейти на medium (средний), это можно сделать, развернув новый узел с нужным размером.
* Разверните новый узел с форм-фактором medium. Этот узел автоматически добавится в ваш существующий кластер.
* После того как развертывание нового узла завершено, удалите один из старых узлов с форм-фактором small.
* Повторяйте этот процесс, пока в кластере не останутся только узлы с форм-фактором medium.

Управление:
* Web GUI.
* SSH (включить при развёртывании или потом отдельно).
* API.

API NSX-T позволяет выполнять определенные задачи, которые нельзя выполнить через GUI (графический интерфейс) или CLI (интерфейс командной строки). API также может автоматизировать конкретные задачи, используя либо нативный API, либо оболочки API (API wrappers) вроде PowerCLI, Terraform и Ansible.

API принимает запросы по TCP-порту 443 через HTTP. Команды API:
* HTTP GET - Считать и получить объекты.
* HTTP PUT, PATCH, POST - Создать и обновить объекты.
* HTTP DELETE - Удалить объекты.


Сервисы кластера разделены на следующие типы (группы сервисов):
* DATASTORE
* CLUSTER_BOOT_MANAGER
* CONTROLLER
* MANAGER
* POLICY
* HTTPS
* MONITORING
* IDPS_REPORTING
* CORFU_NONCONFIG

Ниже приведён фрагмент вывода, показывающий статус кластера для группы MANAGER.
```
pod-230-nsxt-lm> get cluster status
Cluster Id: fbe45219-0fbe-474c-bad8-7e09fd68316a
Overall Status: STABLE
<...output truncated...>
Group Type: MANAGER
Group Status: STABLE
Members:
    UUID                                         FQDN
    ba6e4d56-1848-459f-35bc-d6784d52f0b6        pod-230-nsxt-lm.lab.local
    7f9445e3-ba64-47ae-ab80-68104055ebe8        pod-230-nsxt-lm2
    a0ffd4d0-0c16-46f7-9af1-5063f4f21c3c        pod-230-nsxt-lm3
<...output truncated...>
pod-230-nsxt-lm>
```

Вывод команды `get cluster status verbose` позволяет проверить, какой узел NSX-T Manager является лидерным.

Для NSX-T необходимо сгенерировать четыре CSR: по одному для каждого FQDN узла NSX-T Manager и один для FQDN виртуального IP-адреса. Можно выбрать создание только одного CSR для VIP. Можно создать один CSR со всеми четырьмя альтернативными именами субъекта (SAN) и использовать его для всех узлов NSX-T Manager и VIP. Для FQDN VIP нужно создать CSR с SAN.

Можно использовать любой узел NSX-T Manager для импорта содержимого подписанного сертификата, соответствующих ключей и корневого сертификата CA. Первым шагом является импорт корневого CA-сертификата. После импорта корневого CA-сертификата можно импортировать другие сертификаты с соответствующими ключами в любом порядке. 


После импорта всех сертификатов вам нужно указать NSX-T Manager использовать новый импортированный сертификат. Это можно сделать с помощью вызовов REST API, где вам нужно сослаться на ID сертификата. ID сертификата можно найти в столбце рядом с именем импортированного вами сертификата.

Нужно выполнить вызов REST API к узлу NSX-T Manager:

В таблице 3-6 вы найдёте примеры вызовов REST API для каждого узла, чтобы проверить, действительны ли ваши импортированные сертификаты.
* Проверка (для трёх нод + VIP):
```
GET: https://nsxt-vip.lab.local/api/v1/trust-management/certificates/e59840b6-c73c-4fbf-a780-1c5adbb3fc6b?action=validate
GET: https://nsxt-vip.lab.local/api/v1/trust-management/certificates/95a7491e-2b41-49e0-a924-e554ca798536?action=validate
GET: https://nsxt-vip.lab.local/api/v1/trust-management/certificates/ec3dd6e3-fc55-45e4-8dae-f494e6085858?action=validate
GET: https://nsxt-vip.lab.local/api/v1/trust-management/certificates/be71271e-cf6c-44bf-9597-8214891c64e2?action=validate
```

Успех:
```
{
  "status": "OK"
}
```

* Когда все сертификаты действительны, пришло время применить их к фактическим узлам NSX-T Manager:
```
POST: https://nsxt-01.lab.local/api/v1/node/services/http?action=apply_certificate&certificate_id=e59840b6-c73c-4fbf-a780-1c5adbb3fc6b
POST: https://nsxt-02.lab.local/api/v1/node/services/http?action=apply_certificate&certificate_id=95a7491e-2b41-49e0-a924-e554ca798536
POST: https://nsxt-03.lab.local/api/v1/node/services/http?action=apply_certificate&certificate_id=ec3dd6e3-fc55-45e4-8dae-f494e6085858
POST: https://nsxt-vip.lab.local/api/v1/cluster/api-certificate?action=set_cluster_certificate&certificate_id=be71271e-cf6c-44bf-9597-8214891c64e2
```

NSX-T можно настраивать в двух режимах: Policy и Manager. Режим Policy является рекомендованным и используется по умолчанию для новых установок. Он также поддерживается в NSX-T Global Manager. Режим Policy ещё называют "Simple" (простым), а режим Manager — "Advanced" (продвинутым).

Вы можете переключаться между режимами, используя кнопку Policy/Manager в правом верхнем углу GUI.

1. На вкладке *Networking* вы настраиваете всё, что связано с маршрутизацией и коммутацией, включая сервисы Layer 3, такие как NAT, VPN и балансировка нагрузки. Объекты, созданные в режиме Policy, будут отображаться в режиме Manager, но их нельзя будет редактировать. Перед их названием будет стоять символ, указывающий, что это защищённый объект.
1. Вкладка *Security* используется для создания правил межсетевого экрана и политик безопасности конечных точек.
1. На вкладке *Inventory* вы найдёте информацию о группах, виртуальных машинах, контейнерах, физических серверах, профилях контекста и сервисах.
1. Вкладка *Plan & Troubleshoot* - доступны различные функции для мониторинга и устранения неполадок, такие как Port Mirroring, Traceflow, IPFIX и Consolidated Capacity.
1. Вкладка *System* — это место, где вы подготавливаете и развёртываете узлы-транспорты хоста и Edge, а также выполняете всю основную конфигурацию системы NSX-T. Здесь вы управляете узлами NSX-T Manager, добавляете лицензии, регистрируете Compute Managers, создаёте транспортные зоны и многое другое. Имеет единый вид, который не зависит от режимов Policy или Manager.
